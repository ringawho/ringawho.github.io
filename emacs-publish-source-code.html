<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2024-07-02 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Emacs Publish 的源码高亮问题</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="ring" />
<link rel="stylesheet" href="assets/org-src-block.css" type="text/css" />
<link rel="stylesheet" href="assets/theme.css" type="text/css" />
<script type="text/javascript" src="assets/theme.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Emacs Publish 的源码高亮问题</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org66bd018">1. 源码高亮不正确的问题</a></li>
<li><a href="#org1ec9a83">2. 使用外部 css</a></li>
<li><a href="#orge3b0f31">3. 生成 CSS</a></li>
<li><a href="#org1cf7e9c">4. 完整的方案</a></li>
</ul>
</div>
</div>

<div id="outline-container-org66bd018" class="outline-2">
<h2 id="org66bd018"><span class="section-number-2">1</span> 源码高亮不正确的问题</h2>
<div class="outline-text-2" id="text-1">
<p>
当前 publish org 文件的时候，是将相关 lisp 代码放在一个文件中，再通过 bash 执行 。但写上一篇文章时，突然发现，虽然使用了 <code>htmlize</code> , 代码部分有高亮，但是和主题并不一致，是黑白色，仅有下划线和粗体的样式
</p>


<div class="figure">
<p><img src="./emacs-publish-source-code-images/20240316_144029.png" alt="20240316_144029.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org1ec9a83" class="outline-2">
<h2 id="org1ec9a83"><span class="section-number-2">2</span> 使用外部 css</h2>
<div class="outline-text-2" id="text-2">
<p>
最终发现是 batch 模式中，emacs有字体定义，但是没有颜色。所以解决办法是设置 <code>org-html-htmlize-output-type</code> 为 <code>'css</code> ，然后再增加 CSS 文件
</p>

<p>
在 <code>org-html-htmlize-output-type</code> 方法的文档中，有如下描述，同时文档中建议使用 <code>org-html-htmlize-generate-css</code> 生成相应的 CSS 文件
</p>

<p>
However, this will fail when using Emacs in batch mode for export, because
then no rich font definitions are in place.  It will also not be good if
people with different Emacs setup contribute HTML files to a website,
because the fonts will represent the individual setups.  In these cases,
it is much better to let Org/Htmlize assign classes only, and to use
a style file to define the look of these classes.
To get a start for your css file, start Emacs session and make sure that
all the faces you are interested in are defined, for example by loading files
in all modes you want.  Then, use the command
‘M-x org-html-htmlize-generate-css’ to extract class definitions.
</p>
</div>
</div>

<div id="outline-container-orge3b0f31" class="outline-2">
<h2 id="orge3b0f31"><span class="section-number-2">3</span> 生成 CSS</h2>
<div class="outline-text-2" id="text-3">
<p>
我尝试用 <code>org-html-htmlize-generate-css</code> 生成 CSS，但是出来许多不必要的样式，而且关键是代码高亮依旧是错误的
</p>

<p>
以下是该方法的源码
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="linenr"> 1: </span>(<span class="org-keyword">defun</span> <span class="org-function-name">org-html-htmlize-generate-css</span> ()
<span class="linenr"> 2: </span>  <span class="org-doc">"Create the CSS for all font definitions in the current Emacs session.</span>
<span class="linenr"> 3: </span><span class="org-doc">Use this to create face definitions in your CSS style file that can then</span>
<span class="linenr"> 4: </span><span class="org-doc">be used by code snippets transformed by htmlize.</span>
<span class="linenr"> 5: </span><span class="org-doc">This command just produces a buffer that contains class definitions for all</span>
<span class="linenr"> 6: </span><span class="org-doc">faces used in the current Emacs session.  You can copy and paste the ones you</span>
<span class="linenr"> 7: </span><span class="org-doc">need into your CSS file.</span>
<span class="linenr"> 8: </span>
<span class="linenr"> 9: </span><span class="org-doc">If you then set `</span><span class="org-doc"><span class="org-constant">org-html-htmlize-output-type</span></span><span class="org-doc">' to `</span><span class="org-doc"><span class="org-constant">css</span></span><span class="org-doc">', calls</span>
<span class="linenr">10: </span><span class="org-doc">to the function `</span><span class="org-doc"><span class="org-constant">org-html-htmlize-region-for-paste</span></span><span class="org-doc">' will</span>
<span class="linenr">11: </span><span class="org-doc">produce code that uses these same face definitions."</span>
<span class="linenr">12: </span>  (<span class="org-keyword">interactive</span>)
<span class="linenr">13: </span>  (<span class="org-keyword">unless</span> (<span class="org-keyword">require</span> '<span class="org-constant">htmlize</span> nil t)
<span class="linenr">14: </span>    (<span class="org-warning">error</span> <span class="org-string">"htmlize library missing.  Aborting"</span>))
<span class="linenr">15: </span>  (<span class="org-keyword">and</span> (get-buffer <span class="org-string">"*html*"</span>) (kill-buffer <span class="org-string">"*html*"</span>))
<span class="linenr">16: </span>  (<span class="org-keyword">with-temp-buffer</span>
<span class="linenr">17: </span>    (<span class="org-keyword">let</span> ((fl (face-list))
<span class="linenr">18: </span>          (htmlize-css-name-prefix <span class="org-string">"org-"</span>)
<span class="linenr">19: </span>          (htmlize-output-type 'css)
<span class="linenr">20: </span>          f i)
<span class="linenr">21: </span>      (<span class="org-keyword">while</span> (<span class="org-keyword">setq</span> f (<span class="org-keyword">pop</span> fl)
<span id="coderef-inherit" class="coderef-off"><span class="linenr">22: </span>                   i (<span class="org-keyword">and</span> f (face-attribute f <span class="org-builtin">:inherit</span>)))</span>
<span class="linenr">23: </span>        (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (symbolp f) (<span class="org-keyword">or</span> (not i) (not (listp i))))
<span class="linenr">24: </span>          (insert (org-add-props (copy-sequence <span class="org-string">"1"</span>) nil 'face f))))
<span class="linenr">25: </span>      (htmlize-region (point-min) (point-max))))
<span class="linenr">26: </span>  (pop-to-buffer-same-window <span class="org-string">"*html*"</span>)
<span class="linenr">27: </span>  (goto-char (point-min))
<span class="linenr">28: </span>  (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"&lt;style"</span> nil t)
<span class="linenr">29: </span>    (delete-region (point-min) (match-beginning 0)))
<span class="linenr">30: </span>  (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"&lt;/style&gt;"</span> nil t)
<span class="linenr">31: </span>    (delete-region (1+ (match-end 0)) (point-max)))
<span class="linenr">32: </span>  (beginning-of-line 1)
<span class="linenr">33: </span>  (<span class="org-keyword">when</span> (looking-at <span class="org-string">" +"</span>) (replace-match <span class="org-string">""</span>))
<span class="linenr">34: </span>  (goto-char (point-min)))
</pre>
</div>

<p>
可以看到 <a href="#coderef-inherit" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-inherit');" onmouseout="CodeHighlightOff(this, 'coderef-inherit');">22行和23行</a>，这里会筛选出没有 <code>:inherit</code> 属性的字体，由于我使用的 <code>modus-theme</code> 中设置了此项属性，所以被排除了，所以我们可以重新将这一段重新改一下，顺便将所有 <code>font-lock</code> 的字体筛选出来，这部分才是代码高亮需要用到的
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">while</span> (<span class="org-keyword">setq</span> f (<span class="org-keyword">pop</span> fl))
  (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (symbolp f) (string-match <span class="org-string">"^font-lock"</span> (symbol-name f)))
    (insert (org-add-props (copy-sequence <span class="org-string">"1"</span>) nil 'face f))))
</pre>
</div>

<p>
最终生成的 CSS 中还包含了一些，body 以及 a 标签的样式，这里手动删除以下即可
</p>
</div>
</div>

<div id="outline-container-org1cf7e9c" class="outline-2">
<h2 id="org1cf7e9c"><span class="section-number-2">4</span> 完整的方案</h2>
<div class="outline-text-2" id="text-4">
<ol class="org-ol">
<li><p>
在 build-site.el 中设置变量
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-html-htmlize-output-type 'css)
</pre>
</div></li>
<li><p>
在当前打开的 emacs 中，使用下边改过的方法，生成 CSS
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">org-html-htmlize-generate-css</span> ()
  <span class="org-doc">"Create the CSS for all font definitions in the current Emacs session.</span>
<span class="org-doc">Use this to create face definitions in your CSS style file that can then</span>
<span class="org-doc">be used by code snippets transformed by htmlize.</span>
<span class="org-doc">This command just produces a buffer that contains class definitions for all</span>
<span class="org-doc">faces used in the current Emacs session.  You can copy and paste the ones you</span>
<span class="org-doc">need into your CSS file.</span>

<span class="org-doc">If you then set `</span><span class="org-doc"><span class="org-constant">org-html-htmlize-output-type</span></span><span class="org-doc">' to `</span><span class="org-doc"><span class="org-constant">css</span></span><span class="org-doc">', calls</span>
<span class="org-doc">to the function `</span><span class="org-doc"><span class="org-constant">org-html-htmlize-region-for-paste</span></span><span class="org-doc">' will</span>
<span class="org-doc">produce code that uses these same face definitions."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">unless</span> (<span class="org-keyword">require</span> '<span class="org-constant">htmlize</span> nil t)
    (<span class="org-warning">error</span> <span class="org-string">"htmlize library missing.  Aborting"</span>))
  (<span class="org-keyword">and</span> (get-buffer <span class="org-string">"*html*"</span>) (kill-buffer <span class="org-string">"*html*"</span>))
  (<span class="org-keyword">with-temp-buffer</span>
    (<span class="org-keyword">let</span> ((fl (face-list))
          (htmlize-css-name-prefix <span class="org-string">"org-"</span>)
          (htmlize-output-type 'css)
          f i)
      (<span class="org-keyword">while</span> (<span class="org-keyword">setq</span> f (<span class="org-keyword">pop</span> fl))
        (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (symbolp f) (string-match <span class="org-string">"^font-lock"</span> (symbol-name f)))
          (insert (org-add-props (copy-sequence <span class="org-string">"1"</span>) nil 'face f))))
      (htmlize-region (point-min) (point-max))))
  (pop-to-buffer-same-window <span class="org-string">"*html*"</span>)
  (goto-char (point-min))
  (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"&lt;style"</span> nil t)
    (delete-region (point-min) (match-beginning 0)))
  (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"&lt;/style&gt;"</span> nil t)
    (delete-region (1+ (match-end 0)) (point-max)))
  (beginning-of-line 1)
  (<span class="org-keyword">when</span> (looking-at <span class="org-string">" +"</span>) (replace-match <span class="org-string">""</span>))
  (goto-char (point-min)))
</pre>
</div></li>
<li>将生成的 CSS 自己修剪一下，放在相应的文件中并引入</li>
</ol>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: ring</p>
<p class="date">Date: 2024-03-16</p>
</div>
</body>
</html>
